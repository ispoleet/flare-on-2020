#!/usr/bin/env python3
# ----------------------------------------------------------------------------------------
# FLARE-ON 2021: 3 - Antioch
# ----------------------------------------------------------------------------------------
import os
import json
import zlib
import tarfile


# The association from indices to characters.
index_to_char = (
    "V',`)(//\\\\\|||||" +
    "|||||||_________" +
    "______.........." +
    "................" +
    "................" +
    "................" +
    "................" +
    "................" +
    "................" +
    "................" +
    "................" +
    "................" +
    "................" +
    "................" +
    "................" +
    "................"
)

# The CRC32(author) index map. The order of checksums reveals the layer order.
name_map = [
    0x86A10848, 0xECED85D0, 0x7B665DB3, 0xAB1321CC, 0x94F6471B, 0x7D33089B,
    0xF707E4C3, 0x3FC91ED3, 0x256047CA, 0xD702596F, 0x674404E2, 0x2C2F024D,
    0x018A5232, 0xB59395A9, 0x56CBC85F, 0x550901DA, 0x4F6066D8, 0x5EFDD04B,
    0xD640531C, 0x72B88A33, 0x13468704, 0x10A29E2D, 0xE657D4E1, 0xEDA1CF75,
    0xBBAC124D, 0x2BA1E1D4, 0xA424AFE4, 0x307A73B5, 0xD8549214, 0x80DFE3A6
]

latest_dat = {}


# ----------------------------------------------------------------------------------------
def find_author(filename):
    # Read the author fields from the json file.
    with open(os.path.join(filename, 'json')) as fp:
        data = json.load(fp)
        return data['author'], zlib.crc32((data['author'] + '\n').encode('utf-8'))


# ----------------------------------------------------------------------------------------
def load_layer_files(filename):
    global latest_dat

    tar = tarfile.open(os.path.join(filename, 'layer.tar'))
    # tar.list()

    for alpha in range(26):
        try:
            fp = tar.extractfile('%c.dat' % chr(0x61 + alpha))            
            latest_dat[alpha] = fp.read()
        except KeyError:
            # If a file is missing, ignore it.
            pass

    tar.close()
        

# ----------------------------------------------------------------------------------------
if __name__ == "__main__":
    print('[+] Antioch crack started.')

    # Get all directories that a layer.
    layers_dirs = [it.path for it in os.scandir(os.getcwd()) if it.is_dir()]
    layer_order = {}

    print('[+] Recovering layer order ...')
    for layer_dir in layers_dirs:
        try:
            author, crc32 = find_author(layer_dir)
            index = name_map.index(crc32)

            print('[+] %s ~> %2d ~> %08X ~> %s' % (os.path.basename(layer_dir), index, crc32, author))
            layer_order[index] = layer_dir

        except KeyError:
            # The 7016b68f19aed3bb67ac4bf310defd3f7e0f7dd3ce544177c506d795f0b2acf3 dir
            # contains the main binary so there is no author field in json.
            print('[!] Error! Cannot find author for:', os.path.basename(layer_dir))

    for index in sorted(layer_order):
        print('[+] Collecting files for %2d: %s' % (index, os.path.basename(layer_order[index])))

        load_layer_files(layer_order[index])


    print('[+] XORing the latest version of all dat files ...')
    xor_buf = [0]*4096
    
    for dat_name, buf in latest_dat.items():
        for i in range(4096):
            xor_buf[i] ^= buf[i]

    # Print buffer in 15-byte chunks.
    for i, line in enumerate(xor_buf[i:i+16] for i in range(0, 4096, 16)):
        print(''.join(index_to_char[c] for c in line))

# ----------------------------------------------------------------------------------------
'''
ispo@ispo-glaptop:~/ctf/flare-on-2021/03_antioch$ ./antioch_crack.py 
    [+] Antioch crack started.
    [+] Recovering layer order ...
    [+] e1a9333f9eccfeae42acec6ac459b9025fe6097c065ffeefe5210867e1e2317d ~> 21 ~> 10A29E2D ~> Prince Herbert
    [+] bfefc1bdf8b980a525f58da1550b56daa67bae66b56e49b993fff139faa1472c ~> 11 ~> 2C2F024D ~> Chicken of Bristol
    [+] 7d643931f34d73776e9169551798e1c4ca3b4c37b730143e88171292dbe99264 ~>  5 ~> 7D33089B ~> Sir Bedevere
    [+] 303dfd1f7447a80322cc8a8677941da7116fbf0cea56e7d36a4f563c6f22e867 ~> 24 ~> BBAC124D ~> Sir Ector
    [+] b75ea3e81881c5d36261f64d467c7eb87cd694c85dd15df946601330f36763a4 ~>  0 ~> 86A10848 ~> Miss Islington
    [+] cfd7ddb31ce44bb24b373645876ac7ea372da1f3f31758f2321cc8f5b29884fb ~> 28 ~> D8549214 ~> Black Knight
    [+] fadf53f0ae11908b89dffc3123e662d31176b0bb047182bfec51845d1e81beb9 ~> 23 ~> EDA1CF75 ~> Inspector End Of Film
    [+] e5254dec4c7d10c15e16b41994ca3cf0c5e2b2a56c9d4dc2ef053eeff24333ff ~>  4 ~> 94F6471B ~> Brother Maynard
    [+] ea12384be264c32ec1db0986247a8d4b2231bf017742313c01b05a7e431d9c26 ~>  1 ~> ECED85D0 ~> Sir Bors
    [+] b5f502d32c018d6b2ee6a61f30306f9b46dad823ba503eea5b403951209fd59b ~>  7 ~> 3FC91ED3 ~> Zoot
    [+] 09e6fff53d6496d170aaa9bc88bd39e17c8e5c13ee9066935b089ab0312635ef ~>  3 ~> AB1321CC ~> Dragon of Angnor
    [+] a2de31788db95838a986271665b958ac888d78559aa07e55d2a98fc3baecf6e6 ~> 29 ~> 80DFE3A6 ~> Sir Gallahad
    [+] f9621328166de01de73b4044edb9030b3ad3d5dbc61c0b79e26f177e9123d184 ~> 13 ~> B59395A9 ~> Bridge Keeper
    [+] a435765bcd8745561460979b270878a3e7c729fae46d9e878f4c2d42e5096a44 ~> 18 ~> D640531C ~> Lady of the Lake
    [+] 754ee87063ee108c1f939cd3a28980a03b700f3c3967df8058831edad2743fd7 ~>  6 ~> F707E4C3 ~> Sir Robin
    [+] 25e171d6ac47c26159b26cd192a90d5d37e733eb16e68d3579df364908db30f2 ~> 27 ~> 307A73B5 ~> Dinky
    [+] fd8bf3c084c5dd42159f9654475f5861add943905d0ad1d3672f39e014757470 ~> 17 ~> 5EFDD04B ~> Sir Lancelot
    [+] 9a31bad171ad7e8009fba41193d339271fc51f992b8d574c501cae1bfa6c3fe2 ~> 15 ~> 550901DA ~> Legendary Black Beast of Argh
    [+] 1c5d28d6564aed0316526e8bb2d79a436b45530d2493967c8083fea2b2e518ce ~> 12 ~> 018A5232 ~> Roger the Shrubber
    [+] 8e11477e79016a17e5cde00abc06523856a7db9104c0234803d30a81c50d2b71 ~> 20 ~> 13468704 ~> Sir Not-Appearing-in-this-Film
    [+] cd27ad9a438a7eef05f5b5d99e2454225693e63aba29ce8553800fed23575040 ~> 19 ~> 72B88A33 ~> Rabbit of Caerbannog
    [+] 81f28623cca429f9914e21790722d0351737f8ad3e823619a4f7019be72e2195 ~>  8 ~> 256047CA ~> Squire Concorde
    [+] 6b4e128697aa0459a6caba2088f6f77efaaf29d407ec6b58939c9bc7814688ad ~> 10 ~> 674404E2 ~> Trojan Rabbit
    [+] 76531a907cdecf03c8ac404d91cbcabd438a226161e621fab103a920600372a8 ~>  9 ~> D702596F ~> Green Knight
    [+] e6c2557dc0ff4173baee856cbc5641d5b19706ddb4368556fcdb046f36efd2e2 ~> 22 ~> E657D4E1 ~> King Arthur
    [+] f2ebdc667cbafc2725421d3c02babc957da2370fbd019a9e1993d8b0409f86dd ~> 25 ~> 2BA1E1D4 ~> Squire Patsy
    [+] 49fb821d2bf6d6841ac7cf5005a6f18c4c76f417ac8a53d9e6b48154b5aa1e76 ~> 16 ~> 4F6066D8 ~> A Famous Historian
    [!] Error! Cannot find author for: 7016b68f19aed3bb67ac4bf310defd3f7e0f7dd3ce544177c506d795f0b2acf3
    [+] 58da659c7d1c5a0c3447cb97cd6ffb12027c734bfba32de8b9b362475fe92fae ~> 14 ~> 56CBC85F ~> Sir Gawain
    [+] 4c33f90f25ea2ab1352efb77794ecc424883181cf8e6644946255738ac9f5dbd ~>  2 ~> 7B665DB3 ~> Tim the Enchanter
    [+] 2b363180ec5d5862b2a348db3069b51d79d4e7a277d5cf5e4afe2a54fc04730e ~> 26 ~> A424AFE4 ~> Dennis the Peasant
    [+] Collecting files for  0: b75ea3e81881c5d36261f64d467c7eb87cd694c85dd15df946601330f36763a4
    [+] Collecting files for  1: ea12384be264c32ec1db0986247a8d4b2231bf017742313c01b05a7e431d9c26
    [+] Collecting files for  2: 4c33f90f25ea2ab1352efb77794ecc424883181cf8e6644946255738ac9f5dbd
    [+] Collecting files for  3: 09e6fff53d6496d170aaa9bc88bd39e17c8e5c13ee9066935b089ab0312635ef
    [+] Collecting files for  4: e5254dec4c7d10c15e16b41994ca3cf0c5e2b2a56c9d4dc2ef053eeff24333ff
    [+] Collecting files for  5: 7d643931f34d73776e9169551798e1c4ca3b4c37b730143e88171292dbe99264
    [+] Collecting files for  6: 754ee87063ee108c1f939cd3a28980a03b700f3c3967df8058831edad2743fd7
    [+] Collecting files for  7: b5f502d32c018d6b2ee6a61f30306f9b46dad823ba503eea5b403951209fd59b
    [+] Collecting files for  8: 81f28623cca429f9914e21790722d0351737f8ad3e823619a4f7019be72e2195
    [+] Collecting files for  9: 76531a907cdecf03c8ac404d91cbcabd438a226161e621fab103a920600372a8
    [+] Collecting files for 10: 6b4e128697aa0459a6caba2088f6f77efaaf29d407ec6b58939c9bc7814688ad
    [+] Collecting files for 11: bfefc1bdf8b980a525f58da1550b56daa67bae66b56e49b993fff139faa1472c
    [+] Collecting files for 12: 1c5d28d6564aed0316526e8bb2d79a436b45530d2493967c8083fea2b2e518ce
    [+] Collecting files for 13: f9621328166de01de73b4044edb9030b3ad3d5dbc61c0b79e26f177e9123d184
    [+] Collecting files for 14: 58da659c7d1c5a0c3447cb97cd6ffb12027c734bfba32de8b9b362475fe92fae
    [+] Collecting files for 15: 9a31bad171ad7e8009fba41193d339271fc51f992b8d574c501cae1bfa6c3fe2
    [+] Collecting files for 16: 49fb821d2bf6d6841ac7cf5005a6f18c4c76f417ac8a53d9e6b48154b5aa1e76
    [+] Collecting files for 17: fd8bf3c084c5dd42159f9654475f5861add943905d0ad1d3672f39e014757470
    [+] Collecting files for 18: a435765bcd8745561460979b270878a3e7c729fae46d9e878f4c2d42e5096a44
    [+] Collecting files for 19: cd27ad9a438a7eef05f5b5d99e2454225693e63aba29ce8553800fed23575040
    [+] Collecting files for 20: 8e11477e79016a17e5cde00abc06523856a7db9104c0234803d30a81c50d2b71
    [+] Collecting files for 21: e1a9333f9eccfeae42acec6ac459b9025fe6097c065ffeefe5210867e1e2317d
    [+] Collecting files for 22: e6c2557dc0ff4173baee856cbc5641d5b19706ddb4368556fcdb046f36efd2e2
    [+] Collecting files for 23: fadf53f0ae11908b89dffc3123e662d31176b0bb047182bfec51845d1e81beb9
    [+] Collecting files for 24: 303dfd1f7447a80322cc8a8677941da7116fbf0cea56e7d36a4f563c6f22e867
    [+] Collecting files for 25: f2ebdc667cbafc2725421d3c02babc957da2370fbd019a9e1993d8b0409f86dd
    [+] Collecting files for 26: 2b363180ec5d5862b2a348db3069b51d79d4e7a277d5cf5e4afe2a54fc04730e
    [+] Collecting files for 27: 25e171d6ac47c26159b26cd192a90d5d37e733eb16e68d3579df364908db30f2
    [+] Collecting files for 28: cfd7ddb31ce44bb24b373645876ac7ea372da1f3f31758f2321cc8f5b29884fb
    [+] Collecting files for 29: a2de31788db95838a986271665b958ac888d78559aa07e55d2a98fc3baecf6e6
    [+] XORing the latest version of all dat files ...
    ...............|
    ................
    ................
    ................
    ................
    ................
    ................
    ..............._
    ................
    ....______....._
    ...|..____|.....
    ...|.|__........
    ...|..__|.......
    ...|.|..........
    ...|_|..........
    ................
    ................
    ...._...........
    ...(_).........\
    ...._...........
    ...|.|..........
    ...|.|..........
    ...|_|..........
    ................
    ................
    ................
    ................
    ...__...__......
    ...\.\././......
    ....\.V./.......
    .....\_/......._
    ................
    ................
    ................
    ................
    .....___........
    ..../._.\.......
    ...|..__/.......
    ....\___|.......
    ................
    ................
    ................
    ................
    ....______......
    ...|______|.....
    ................
    ................
    ................
    ................
    ...._____.......
    ...|_..._|......
    .....|.|........
    .....|.|........
    ...._|.|_.......
    ...|_____|.....|
    ................
    ................
    ................
    ...............\
    ....___.........
    .../.__|........
    ...\__.\......._
    ...|___/.......|
    ................
    ................
    ................
    ................
    ....______......
    ...|______|.....
    ................
    ................
    ................
    ................
    ...._____.......
    ...|..__.\......
    ...|.|__).|.....
    ...|.._../......
    ...|.|.\.\......
    ...|_|..\_\.....
    ................
    ................
    ...._...........
    ...(_).........|
    ...._...........
    ...|.|..........
    ...|.|..........
    ...|_|..........
    ................
    ................
    ................
    ................
    .....__._.......
    ..../._`.|......
    ...|.(_|.|......
    ....\__,.|......
    .....__/.|......
    ....|___/.......
    ...._...........
    ...|.|..........
    ...|.|__........
    ...|.'_.\.......
    ...|.|.|.|......
    ...|_|.|_|......
    ................
    ..............._
    ...._...........
    ...|.|..........
    ...|.|_.........
    ...|.__|........
    ...|.|_.........
    ....\__|........
    ................
    ................
    ................
    ................
    ....______....._
    ...|______|.....
    ..............._
    ................
    ................
    ................
    .....____.......
    ..../.__.\......
    ...|.|..|.|.....
    ...|.|..|.|.....
    ...|.|__|.|.....
    ....\____/......
    ................
    ................
    ................
    ................
    ...._..._.......
    ...|.|.|.|.....|
    ...|.|_|.|......
    ....\__,_|......
    ................
    ................
    ...._...........
    ...|.|..........
    ...|.|_.........
    ...|.__|......._
    ...|.|_.........
    ....\__|......._
    ................
    ...............)
    ................
    ......____......
    ...../.__.\...._
    ...././._`.|..._
    ...|.|.(_|.|....
    ....\.\__,_|....
    .....\____/.....
    ................
    .....__........`
    ..../._|........
    ...|.|_.........
    ...|.._|........
    ...|.|..........
    ...|_|..........
    ................
    ................
    ...._...........
    ...|.|..........
    ...|.|..........
    ...|.|..........
    ...|.|........./
    ...|_|..........
    ................
    ................
    ................
    ................
    .....__._......|
    ..../._`.|......
    ...|.(_|.|......
    ....\__,_|......
    ................
    ...............'
    ................
    ................
    ...._.__........
    ...|.'__|......_
    ...|.|........._
    ...|_|..........
    ................
    ................
    ................
    ................
    .....___........
    ..../._.\.......
    ...|..__/......)
    ....\___|.......
    ................
    ................
    ................
    ................
    ....______......
    ...|______|...._
    ................
    ................
    ...............V
    ................
    ................
    ................
    .....___........
    ..../._.\.......
    ...|.(_).|......
    ....\___/.......
    ................
    ................
    ................
    ................
    ...._.__........
    ...|.'_.\.......
    ...|.|.|.|......
    ...|_|.|_|.....)
    ................
    ................
    ................
    ................
    ..............._
    ................
    ...._.........._
    ...(_)..........
    ................
    ................
    ................
    ..............._
    .....___.......\
    ..../.__|.......
    ...|.(__........
    ....\___|.......
    ................
    ................
    ................
    ................
    .....___........
    ..../._.\.......
    ...|.(_).|......
    ....\___/.......
    ................
    ................
    ................
    ................
    ...._.__.___...\
    ...|.'_.`._.\...
    ...|.|.|.|.|.|._
    ...|_|.|_|.|_|.\
    ................
    ................
    ................
    ................
    ................
    ................
    ................
    ................
    ................
'''
# ----------------------------------------------------------------------------------------

