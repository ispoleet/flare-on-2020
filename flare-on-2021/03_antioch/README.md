

## Flare-On 2021 - #3 Antioch
___

### Description: 

*To solve this challenge, you'll need to ...AAARGH*

`7-zip password: flare`

___


### Solution: 

The main binary is located under **7016b68f19aed3bb67ac4bf310defd3f7e0f7dd3ce544177c506d795f0b2acf3/AntiochOS**
and supports **2** commands: `consult` and `approach`. The `consult` command is handled by
the `u_do_consult_cmd` function at `401460h`:
```C
__int64 u_do_consult_cmd() {
  *(_DWORD *)file_idx = 'a';
  *(_QWORD *)a1 = 'tad..';                      // '..dat'
  memset(dst_buf, 0, sizeof(dst_buf));
  v1 = (char *)u_consult_book_msg();
  u_syscall_write(1u, v1, 0x1FuLL);
  u_syscall_select(2);
  do                                            // XOR all files together
  {
    while ( 1 )
    {
      a1[0] = file_idx[0];
      fd = u_syscall_open(a1, (__int64)v1);     // open 'a.dat', 'b.dat' and so on
      fd_1 = fd;
      if ( fd >= 0 )
        break;
      ++*(_DWORD *)file_idx;
      if ( file_idx[0] == '{' )
        goto LOOP_END;
    }
    u_syscall_read(fd, src_buf, 0x1000uLL);
    u_syscall_close(fd_1);
    dst_buf_1 = dst_buf;
    v5 = src_buf;
    v1 = v12;
    do
      *dst_buf_1++ ^= *v5++;
    while ( dst_buf_1 != v12 );
    ++*(_DWORD *)file_idx;
  }
  while ( file_idx[0] != '{' );
LOOP_END:
  if ( !(_BYTE)glo_map_array )
  {
    glo_map_array = (__int128)_mm_load_si128((const __m128i *)&xmmword_402240);
    xmmword_404110 = glo_map_array;
    xmmword_404120 = glo_map_array;
    xmmword_404130 = glo_map_array;
    xmmword_404140 = glo_map_array;
    xmmword_404150 = glo_map_array;
    xmmword_404160 = glo_map_array;
    xmmword_404170 = glo_map_array;
    xmmword_404180 = glo_map_array;
    xmmword_404190 = glo_map_array;
    xmmword_4041A0 = glo_map_array;
    xmmword_4041B0 = glo_map_array;
    xmmword_4041C0 = glo_map_array;
    xmmword_4041D0 = glo_map_array;
    xmmword_4041E0 = glo_map_array;
    xmmword_4041F0 = glo_map_array;
    u_set_map_chars_msg(&glo_map_array);
  }
  for ( i = 0LL; i != 4096; ++i )               // create map
  {
    v7 = '\n';
    if ( (i & 0xF) != 15 )
      v7 = *((_BYTE *)&glo_map_array + (unsigned __int8)dst_buf[i]);
    dst_buf[i] = v7;
  }
  return u_syscall_write(1u, dst_buf, 0x1000uLL);
}
```

This function takes all `*.dat` files from a given layer and XORs all of them together
(byte-by-byte). After XOR, each byte is substituted with a character from `glo_map_array`
located at `404100h`:
```
V',`)(//\\\||||||||||||_______________..........................
................................................................
................................................................
................................................................
```

Finally, it prints the XORed array in **15**-byte blocks (and ignores every **16**-th block).
For example:
```
> consult
Consult the Book of Armaments!
.............._
.....(.........
.|.......|_....
/._.._...|_....
..V.,........|.

[..... TRUNCATED FOR BREVITY .....]

...._..........
...............
...........|_..
.,.._........_.
........._.._|.
> 
```

The approach command is handled by the `u_do_approach_cmd` function at `401640h`:
```C
__int64 u_do_approach_cmd() {
  iter = 0LL;
  newline = '\n';
  str = (char *)u_set_approach_Gorge();
  u_syscall_write(1u, str, 0x25uLL);
  u_syscall_select(1);
  u_set_whats_your_name(name_str);
  u_syscall_write(1u, name_str, 0x13uLL);
  v2 = u_syscall_read(0, name, 0x80uLL);
  crc = u_calc_crc32(name, v2);
  v4 = glo_crc_search_array;
  crc_1 = 0xB59395A9;
  while ( crc_1 != crc )                        // search for expected crc_1
  {
    iter = (unsigned int)(iter + 1);
    if ( (_DWORD)iter == 30 )
      return u_syscall_write(1u, "...AAARGH\n\n", 0xBuLL);
    crc_1 = v4->crc_1;
    ++v4;
  }
  u_set_whats_your_quest(name_str);
  u_syscall_write(1u, name_str, 0x14uLL);
  if ( u_syscall_read(0, name, 0x80uLL) > 1 )   // quest is wasted
  {
    u_set_whats_your_fav_color(name_str);
    u_syscall_write(1u, name_str, 0x1DuLL);
    size = u_syscall_read(0, name, 0x80uLL);    // no null byte added!
    crc32_color = u_calc_crc32(name, size);
    my_struct = &glo_good_crc32_values[iter];
    if ( my_struct->crc_2 == crc32_color )
    {
      idx = my_struct->index;
      if ( idx > 0 )
      {
        u_itoa_recursive(idx, name);            // color
        v10 = (char *)u_set_right_off_you_go();
        u_syscall_write(1u, v10, 0x14uLL);
        u_syscall_write(1u, name, strlen(name));
        return u_syscall_write(1u, &newline, 1uLL);
      }
    }
  }
  return u_syscall_write(1u, "...AAARGH\n\n", 0xBuLL);
}
```

This function takes a name, calculates its CRC32 checksum and searches for that value in 
`glo_good_crc32_values` struct array at `402000h`. If the entry is found, it asks for a
quest (which is ignored) and a color. If the CRC32 of the color matches the **2nd** struct field
of the entry, function returns an index. Each entry has the following layout:
```
crc_1 -> CRC32 of author from json file
crc_2 -> CRC32 of color (unknown)
index -> Unique number in [1, 30] range -> probably next layer
```

The contents of the `glo_crc_search_array` are shown below:
```
B59395A9h, 1BB5AB29h, 0Eh
5EFDD04Bh, 3F8468C8h, 12h
ECED85D0h, 82D23D48h, 02h
D8549214h, 00472EE5h, 1Dh
2C2F024Dh, C9A060AAh, 0Ch
018A5232h, 0024D235h, 0Dh
72B88A33h, 81576613h, 14h
674404E2h, 5169E129h, 0Bh
307A73B5h, E560E13Eh, 1Ch
13468704h, 2358E4A9h, 15h
94F6471Bh, D6341A53h, 05h
EDA1CF75h, BAFA91E5h, 18h
BBAC124Dh, A697641Dh, 19h
F707E4C3h, EF185643h, 07h
D702596Fh, 79C28915h, 0Ah
86A10848h, 59108FDCh, 01h
D640531Ch, EF3DE1E8h, 13h
7B665DB3h, A3A903B0h, 03h
AB1321CCh, EEEDEAD7h, 04h
4F6066D8h, 9C8A3D07h, 11h
256047CAh, 4085BE9Eh, 09h
3FC91ED3h, 379549C9h, 08h
A424AFE4h, EF871347h, 1Bh
550901DAh, 01FCEC6Bh, 10h
10A29E2Dh, E76056AAh, 16h
56CBC85Fh, 356F1A68h, 0Fh
80DFE3A6h, 9D0AB536h, 1Eh
E657D4E1h, B4E9FD30h, 17h
2BA1E1D4h, BE66D918h, 1Ah
7D33089Bh, 67C1F585h, 06h
```

The numbers at the end of each entry correspond to indices since each number appears only
once and it is a number between `1` and `len(glo_crc_search_array)`. This is also the number
of directories in the challenge `-1`. The next question is what names could result to these 
CRC32 checksums? Let's look at a json file:
```json
ispo@ispo-glaptop:~/ctf/flare-on-2021/03_antioch$ cat 09e6fff53d6496d170aaa9bc88bd39e17c8e5c13ee9066935b089ab0312635ef/json | json_pp
{
   "architecture" : "amd64",
   "author" : "Dragon of Angnor",
   "config" : {
      "AttachStderr" : false,
      "AttachStdin" : false,
      "AttachStdout" : false,
      "Cmd" : null,
      "Domainname" : "",
      "Entrypoint" : null,
      "Env" : [
         "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      ],
      "Hostname" : "",
      "Image" : "",
      "Labels" : null,
      "OnBuild" : null,
      "OpenStdin" : false,
      "StdinOnce" : false,
      "Tty" : false,
      "User" : "",
      "Volumes" : null,
      "WorkingDir" : ""
   },
   "container_config" : {
      "AttachStderr" : false,
      "AttachStdin" : false,
      "AttachStdout" : false,
      "Cmd" : [
         "/bin/sh",
         "-c",
         "#(nop) ADD multi:cac4629faae36e1a69040f3ca0fb3377ddd7eb285ac22bc701f064de1bf22f46 in / "
      ],
      "Domainname" : "",
      "Entrypoint" : null,
      "Env" : [
         "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      ],
      "Hostname" : "",
      "Image" : "",
      "Labels" : null,
      "OnBuild" : null,
      "OpenStdin" : false,
      "StdinOnce" : false,
      "Tty" : false,
      "User" : "",
      "Volumes" : null,
      "WorkingDir" : ""
   },
   "created" : "1975-04-03T12:00:00.000000000Z",
   "docker_version" : "20.10.2",
   "id" : "09e6fff53d6496d170aaa9bc88bd39e17c8e5c13ee9066935b089ab0312635ef",
   "os" : "linux"
}
```

The only name we see here is the `author` field. Let's try it out:
```
ispo@ispo-glaptop:~/ctf/flare-on-2021/03_antioch$ echo Dragon of Angnor | tee foo; crc32 foo
Dragon of Angnor
ab1321cc
```

This CRC32 checksum matches the `AB1321CCh, EEEDEAD7h, 04h` entry. That is, it means that
the files under `09e6fff53d6496d170aaa9bc88bd39e17c8e5c13ee9066935b089ab0312635ef` directory
are the **4th** layer.
The task is clear now: We have to combine the `*.dat` files from each layer in the right
order and combine them together. The right order is shown below (based on `glo_crc_search_array`
and the `CRC32(author)` from each `json` file in each directory):
```
b75ea3e81881c5d36261f64d467c7eb87cd694c85dd15df946601330f36763a4
ea12384be264c32ec1db0986247a8d4b2231bf017742313c01b05a7e431d9c26
4c33f90f25ea2ab1352efb77794ecc424883181cf8e6644946255738ac9f5dbd
09e6fff53d6496d170aaa9bc88bd39e17c8e5c13ee9066935b089ab0312635ef
e5254dec4c7d10c15e16b41994ca3cf0c5e2b2a56c9d4dc2ef053eeff24333ff
7d643931f34d73776e9169551798e1c4ca3b4c37b730143e88171292dbe99264
754ee87063ee108c1f939cd3a28980a03b700f3c3967df8058831edad2743fd7
b5f502d32c018d6b2ee6a61f30306f9b46dad823ba503eea5b403951209fd59b
81f28623cca429f9914e21790722d0351737f8ad3e823619a4f7019be72e2195
76531a907cdecf03c8ac404d91cbcabd438a226161e621fab103a920600372a8
6b4e128697aa0459a6caba2088f6f77efaaf29d407ec6b58939c9bc7814688ad
bfefc1bdf8b980a525f58da1550b56daa67bae66b56e49b993fff139faa1472c
1c5d28d6564aed0316526e8bb2d79a436b45530d2493967c8083fea2b2e518ce
f9621328166de01de73b4044edb9030b3ad3d5dbc61c0b79e26f177e9123d184
58da659c7d1c5a0c3447cb97cd6ffb12027c734bfba32de8b9b362475fe92fae
9a31bad171ad7e8009fba41193d339271fc51f992b8d574c501cae1bfa6c3fe2
49fb821d2bf6d6841ac7cf5005a6f18c4c76f417ac8a53d9e6b48154b5aa1e76
fd8bf3c084c5dd42159f9654475f5861add943905d0ad1d3672f39e014757470
a435765bcd8745561460979b270878a3e7c729fae46d9e878f4c2d42e5096a44
cd27ad9a438a7eef05f5b5d99e2454225693e63aba29ce8553800fed23575040
8e11477e79016a17e5cde00abc06523856a7db9104c0234803d30a81c50d2b71
e1a9333f9eccfeae42acec6ac459b9025fe6097c065ffeefe5210867e1e2317d
e6c2557dc0ff4173baee856cbc5641d5b19706ddb4368556fcdb046f36efd2e2
fadf53f0ae11908b89dffc3123e662d31176b0bb047182bfec51845d1e81beb9
303dfd1f7447a80322cc8a8677941da7116fbf0cea56e7d36a4f563c6f22e867
f2ebdc667cbafc2725421d3c02babc957da2370fbd019a9e1993d8b0409f86dd
2b363180ec5d5862b2a348db3069b51d79d4e7a277d5cf5e4afe2a54fc04730e
25e171d6ac47c26159b26cd192a90d5d37e733eb16e68d3579df364908db30f2
cfd7ddb31ce44bb24b373645876ac7ea372da1f3f31758f2321cc8f5b29884fb
a2de31788db95838a986271665b958ac888d78559aa07e55d2a98fc3baecf6e6
```

The question now is how do we combine them? My first approach was to concatenate all these
layers together and create a wide map, which would contain the flag as ASCII art. However,
this approach was not correct. Then the word "layer" made me think that I should place all
these ASCII "stripes" from each directory, **on top** of each other and **not next** to each
other. After a lot of trial and error, I found the correct approach:
**We get the latest *.dat file from each layer and we XOR all them together.**
By doing that, we can get the flag as an ASCII art:
```
...............|
................
................
................
................
................
................
..............._
................
....______....._
...|..____|.....
...|.|__........
...|..__|.......
...|.|..........
...|_|..........
................
................
...._...........
...(_).........\
...._...........
...|.|..........
...|.|..........
...|_|..........
................
................
................
................
...__...__......
...\.\././......
....\.V./.......
.....\_/......._
................
................
................
................
.....___........
..../._.\.......
...|..__/.......
....\___|.......
................
................
................
................
....______......
...|______|.....
................
................
................
................
...._____.......
...|_..._|......
.....|.|........
.....|.|........
...._|.|_.......
...|_____|.....|
................
................
................
...............\
....___.........
.../.__|........
...\__.\......._
...|___/.......|
................
................
................
................
....______......
...|______|.....
................
................
................
................
...._____.......
...|..__.\......
...|.|__).|.....
...|.._../......
...|.|.\.\......
...|_|..\_\.....
................
................
...._...........
...(_).........|
...._...........
...|.|..........
...|.|..........
...|_|..........
................
................
................
................
.....__._.......
..../._`.|......
...|.(_|.|......
....\__,.|......
.....__/.|......
....|___/.......
...._...........
...|.|..........
...|.|__........
...|.'_.\.......
...|.|.|.|......
...|_|.|_|......
................
..............._
...._...........
...|.|..........
...|.|_.........
...|.__|........
...|.|_.........
....\__|........
................
................
................
................
....______....._
...|______|.....
..............._
................
................
................
.....____.......
..../.__.\......
...|.|..|.|.....
...|.|..|.|.....
...|.|__|.|.....
....\____/......
................
................
................
................
...._..._.......
...|.|.|.|.....|
...|.|_|.|......
....\__,_|......
................
................
...._...........
...|.|..........
...|.|_.........
...|.__|......._
...|.|_.........
....\__|......._
................
...............)
................
......____......
...../.__.\...._
...././._`.|..._
...|.|.(_|.|....
....\.\__,_|....
.....\____/.....
................
.....__........`
..../._|........
...|.|_.........
...|.._|........
...|.|..........
...|_|..........
................
................
...._...........
...|.|..........
...|.|..........
...|.|..........
...|.|........./
...|_|..........
................
................
................
................
.....__._......|
..../._`.|......
...|.(_|.|......
....\__,_|......
................
...............'
................
................
...._.__........
...|.'__|......_
...|.|........._
...|_|..........
................
................
................
................
.....___........
..../._.\.......
...|..__/......)
....\___|.......
................
................
................
................
....______......
...|______|...._
................
................
...............V
................
................
................
.....___........
..../._.\.......
...|.(_).|......
....\___/.......
................
................
................
................
...._.__........
...|.'_.\.......
...|.|.|.|......
...|_|.|_|.....)
................
................
................
................
..............._
................
...._.........._
...(_)..........
................
................
................
..............._
.....___.......\
..../.__|.......
...|.(__........
....\___|.......
................
................
................
................
.....___........
..../._.\.......
...|.(_).|......
....\___/.......
................
................
................
................
...._.__.___...\
...|.'_.`._.\...
...|.|.|.|.|.|._
...|_|.|_|.|_|.\
................
................
................
................
................
................
................
................
................
```

Which gives us the flag: `Five-Is-Right-Out@flare-on.com`

For more details, please take a look at the [antioch_crack.py](./antioch_crack.py) file.

___

